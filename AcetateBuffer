"""
Monte Carlo estimation of the ionic strength of a NaOAc/HCl acetate buffer.

The script samples experimental parameters (mass of NaOAc, volumes, pH, pKa, etc.)
from normal distributions and computes the ionic strength for each Monte Carlo
replicate, assuming:

1. All acetate initially comes from NaOAc and is fully deprotonated (Ac⁻).
2. Addition of HCl protonates a fraction of Ac⁻ to HAc.
3. [Ac⁻] and [HAc] are obtained via the Henderson–Hasselbalch equation using
   the total acetate concentration C_T, pH, and pKa.
4. The ionic strength includes contributions from Na⁺, Cl⁻, Ac⁻, H₃O⁺ and OH⁻,
   all treated as monovalent ions.

Outputs
-------
- <out-prefix>_stats.txt   : summary statistics of ionic strength
- <out-prefix>_samples.csv : full table of sampled parameters and results
"""

import argparse
from typing import Any

import numpy as np
import pandas as pd


def parse_args() -> argparse.Namespace:
    """Parse command-line arguments."""
    parser = argparse.ArgumentParser(
        description=(
            "Monte Carlo estimation of the ionic strength of a NaOAc/HCl "
            "acetate buffer."
        )
    )

    # Experimental parameters (mean values and standard deviations)
    parser.add_argument(
        "--mass-mean",
        type=float,
        required=True,
        help="Mean mass of NaOAc (g).",
    )
    parser.add_argument(
        "--mass-sd",
        type=float,
        required=True,
        help="Standard deviation of NaOAc mass (g).",
    )

    parser.add_argument(
        "--Vtot-mean",
        type=float,
        required=True,
        help="Mean final solution volume (L).",
    )
    parser.add_argument(
        "--Vtot-sd",
        type=float,
        required=True,
        help="Standard deviation of final solution volume (L).",
    )

    parser.add_argument(
        "--CHCl-mean",
        type=float,
        required=True,
        help="Mean HCl concentration (mol/L).",
    )
    parser.add_argument(
        "--CHCl-sd",
        type=float,
        required=True,
        help="Standard deviation of HCl concentration (mol/L).",
    )

    parser.add_argument(
        "--VHCl-mean",
        type=float,
        required=True,
        help="Mean volume of added HCl (L).",
    )
    parser.add_argument(
        "--VHCl-sd",
        type=float,
        required=True,
        help="Standard deviation of added HCl volume (L).",
    )

    parser.add_argument(
        "--pH-mean",
        type=float,
        required=True,
        help="Mean measured pH of the buffer.",
    )
    parser.add_argument(
        "--pH-sd",
        type=float,
        required=True,
        help="Standard deviation of pH.",
    )

    parser.add_argument(
        "--pKa-mean",
        type=float,
        default=4.76,
        help="Mean pKa of acetic acid (default: 4.76).",
    )
    parser.add_argument(
        "--pKa-sd",
        type=float,
        default=0.02,
        help="Standard deviation of pKa (default: 0.02).",
    )

    parser.add_argument(
        "--N",
        type=int,
        default=100_000,
        help="Number of Monte Carlo simulations (default: 100000).",
    )
    parser.add_argument(
        "--seed",
        type=int,
        default=123,
        help="Random number generator seed (default: 123).",
    )
    parser.add_argument(
        "--out-prefix",
        type=str,
        default="mc_ionic_strength",
        help="Prefix for output files (default: mc_ionic_strength).",
    )

    return parser.parse_args()


def main() -> None:
    args = parse_args()
    rng = np.random.default_rng(args.seed)

    # Constants
    M_NaOAc = 82.034  # g/mol, anhydrous sodium acetate
    Kw = 1.0e-14      # ionic product of water at ~25 °C

    N: int = args.N

    # 1) Sample experimental parameters (normal distributions)
    mass = rng.normal(args.mass_mean, args.mass_sd, size=N)   # g
    Vtot = rng.normal(args.Vtot_mean, args.Vtot_sd, size=N)   # L
    CHCl = rng.normal(args.CHCl_mean, args.CHCl_sd, size=N)   # mol/L
    VHCl = rng.normal(args.VHCl_mean, args.VHCl_sd, size=N)   # L
    pH = rng.normal(args.pH_mean, args.pH_sd, size=N)         # -
    pKa = rng.normal(args.pKa_mean, args.pKa_sd, size=N)      # -

    # Avoid non-physical values
    mass = np.clip(mass, 0.0, None)
    Vtot = np.clip(Vtot, 1e-6, None)
    CHCl = np.clip(CHCl, 0.0, None)
    VHCl = np.clip(VHCl, 0.0, None)

    # 2) Moles of NaOAc and total acetate concentration:
    #    C_T = [Ac-] + [HAc]
    n_NaOAc = mass / M_NaOAc         # mol
    C_T = n_NaOAc / Vtot             # mol/L

    # 3) Base/acid ratio from pH (Henderson–Hasselbalch)
    #    R = [Ac-] / [HAc]
    R = 10.0 ** (pH - pKa)

    # 4) [HAc] and [Ac-] from mass balance:
    #    C_T = [Ac-] + [HAc] and [Ac-] = R * [HAc]
    #    => [HAc] = C_T / (1 + R), [Ac-] = C_T * R / (1 + R)
    denom = 1.0 + R
    denom = np.where(denom == 0.0, np.inf, denom)  # avoid division by zero

    HAc = C_T / denom           # [HAc]
    Ac_minus = C_T * R / denom  # [Ac-]

    # 5) Stoichiometry with HCl (diagnostic; not used directly for I)
    n_Hplus_from_HCl = CHCl * VHCl          # mol
    # H+ consumed to protonate acetate (initially all as Ac- from NaOAc)
    n_Hplus_consumed = n_NaOAc - Ac_minus * Vtot  # mol

    # 6) Ionic concentrations
    # Na+ from NaOAc
    Na_plus = n_NaOAc / Vtot          # [Na+]
    # Cl- from HCl
    Cl_minus = n_Hplus_from_HCl / Vtot  # [Cl-]

    # Ac- is already Ac_minus
    # H3O+ from pH
    H3O_plus = 10.0 ** (-pH)
    # OH- from Kw
    OH_minus = Kw / H3O_plus

    # 7) Ionic strength
    # All ions are monovalent -> z_i^2 = 1
    I = 0.5 * (Na_plus + Cl_minus + Ac_minus + H3O_plus + OH_minus)

    # 8) Basic statistics on ionic strength
    I_mean = np.mean(I)
    I_std = np.std(I, ddof=1)
    I_p2_5, I_p50, I_p97_5 = np.percentile(I, [2.5, 50, 97.5])

    stats_text = (
        f"N simulations: {N}\n"
        f"I_mean      = {I_mean:.6e} M\n"
        f"I_std       = {I_std:.6e} M\n"
        f"I_2.5%      = {I_p2_5:.6e} M\n"
        f"I_50% (med) = {I_p50:.6e} M\n"
        f"I_97.5%     = {I_p97_5:.6e} M\n"
    )

    # 9) Save results
    with open(f"{args.out_prefix}_stats.txt", "w", encoding="utf-8") as f:
        f.write(stats_text)

    df = pd.DataFrame(
        {
            "mass_g": mass,
            "Vtot_L": Vtot,
            "CHCl_M": CHCl,
            "VHCl_L": VHCl,
            "pH": pH,
            "pKa": pKa,
            "C_T_M": C_T,
            "[HAc]_M": HAc,
            "[Ac-]_M": Ac_minus,
            "[Na+]_M": Na_plus,
            "[Cl-]_M": Cl_minus,
            "[H3O+]_M": H3O_plus,
            "[OH-]_M": OH_minus,
            "I_M": I,
            "n_H+_from_HCl_mol": n_Hplus_from_HCl,
            "n_H+_consumed_mol": n_Hplus_consumed,
        }
    )
    df.to_csv(f"{args.out_prefix}_samples.csv", index=False)

    print(stats_text)


if __name__ == "__main__":
    main()
